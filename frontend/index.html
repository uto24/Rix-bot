<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>RiX Earn</title>
    
    <!-- Font Awesome ‡¶Ü‡¶á‡¶ï‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø CDN ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- Monetag SDK ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø -->
    <script async src='https://libtl.com/sdk.js' data-zone='9504423' data-sdk='show_9504423'></script>

    <style>
        :root { --tg-theme-bg-color: #171a21; --tg-theme-text-color: #fff; --tg-theme-button-color: #3bff00; --tg-theme-button-text-color: #000; --tg-theme-hint-color: #9099a2; --tg-theme-secondary-bg-color: #2a2c3c; --primary-accent-color: #3bff00; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: url(https://i.postimg.cc/FzSSKJ7b/74f07007-acd0-4431-a647-ae287dc00382.jpg) no-repeat center center fixed; background-size: cover; color: var(--tg-theme-text-color); margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .main-content { flex-grow: 1; padding: 20px; overflow-y: auto; display: none; text-align: center; }
        .main-content.active { display: flex; flex-direction: column; align-items: center; }
        .info-card { background: rgba(0, 77, 7, 0.22); border-radius: 16px; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(0, 255, 66, 0.12); padding: 20px; margin-bottom: 15px; width: 90%; max-width: 400px; box-sizing: border-box; }
        .info-card h3 { margin-top: 0; color: var(--primary-accent-color); display: flex; align-items: center; justify-content: center; gap: 8px; }
        .info-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #3a3c4c; }
        .info-item:last-child { border-bottom: none; }
        .input-group { display: flex; align-items: center; margin-top: 10px; }
        .input-group input { flex-grow: 1; background-color: #3a3c4c; border: 1px solid #555; color: white; padding: 10px; border-radius: 8px 0 0 8px; font-size: 0.9em; }
        .input-group button { background-color: var(--primary-accent-color); border: none; color: var(--tg-theme-button-text-color); padding: 11px 15px; border-radius: 0 8px 8px 0; cursor: pointer; }
        .main-button { width: 100%; background-color: var(--primary-accent-color); color: #000; border: none; padding: 15px 0; font-size: 1.1em; font-weight: bold; border-radius: 10px; cursor: pointer; margin-top: 10px; }
        .main-button:disabled { background-color: #555; color: #aaa; cursor: not-allowed; }
        .bottom-nav { width: 100%; display: flex; justify-content: space-around; padding: 10px 0; background-color: var(--tg-theme-secondary-bg-color); border-top: 1px solid #3a3c4c; }
        .nav-button { background: none; border: none; color: var(--tg-theme-hint-color); cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 0.8em; }
        .nav-button.active { color: var(--primary-accent-color); }
        .nav-button i { font-size: 1.5em; }
        .withdraw-styles { text-align: center; }
        .withdraw-styles h2 { color: var(--primary-accent-color); font-size: 1.8em; margin-bottom: 1rem; }
        .withdraw-styles ul { list-style: none; padding: 0; margin: 1.5rem 0; display: flex; flex-direction: column; gap: 10px; }
        .withdraw-styles li { background-color: var(--tg-theme-bg-color); padding: 12px 20px; border-radius: 8px; border-left: 4px solid var(--primary-accent-color); font-size: 1.1em; text-align: left; display: flex; align-items: center; gap: 10px; }
        .withdraw-styles .rates { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin: 2rem 0; }
        .withdraw-styles .rate-card { background-color: var(--tg-theme-bg-color); padding: 15px; border-radius: 10px; border: 1px solid var(--tg-theme-hint-color); flex-grow: 1; min-width: 130px; }
        .withdraw-styles .methods h3 { color: var(--tg-theme-hint-color); text-transform: uppercase; font-size: 0.9em; letter-spacing: 1px; margin-bottom: 1rem; }
        .withdraw-styles .method-icons { display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 12px; }
        .withdraw-styles .payment-method { background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); padding: 8px 16px; border-radius: 20px; font-size: 0.9em; }
    </style>
</head>
<body>
    <!-- Mining Section -->
    <div id="mining-section" class="main-content active">
        <div class="info-card"><h3><i class="fa-solid fa-person-digging"></i> Mining Hub</h3><p>Claim your mining reward every 8 hours!</p><button id="mining-claim-btn" class="main-button" disabled>Loading...</button><p id="mining-timer" class="timer-text">...</p><p>Made in Bangladesh üáßüá© | Developed by : Chiper X</p></div>
        <div class="info-card"><h3><i class="fa-solid fa-circle-info"></i> ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶ï‡¶•‡¶æ</h3><p>‡¶Ö‡¶®‡ßá‡¶ï ‡¶ï‡¶∑‡ßç‡¶ü‡ßá ‡¶¨‡¶ü‡¶ü‡¶ø ‡¶¨‡¶æ‡¶®‡¶æ‡¶®‡ßã, ‡¶§‡¶æ‡¶á ‡¶Ø‡¶¶‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶è‡¶° ‡¶¶‡ßá‡¶ñ‡¶ø‡ßü‡ßá ‡¶≤‡¶æ‡¶≠ ‡¶®‡¶æ ‡¶π‡ßü, ‡¶§‡¶æ‡¶π‡¶≤‡ßá ‡¶ï‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶¶‡¶ø‡¶¨‡ßã‡•§ ‡¶Ü‡¶Æ‡¶ø ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®‡ßá‡¶∞ ‡¶ï‡¶æ‡¶ú ‡¶¨‡ßÅ‡¶ù‡¶ø, ‡¶Ü‡¶Æ‡¶ø ‡¶®‡¶ø‡¶ú‡ßá‡¶ì ‡¶Ö‡¶®‡ßá‡¶ï ‡¶ú‡¶æ‡ßü‡¶ó‡¶æ‡ßü ‡¶™‡ßç‡¶∞‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡¶ø‡•§ ‡¶§‡¶æ‡¶á ‡¶ï‡¶∑‡ßç‡¶ü ‡¶ü‡¶æ ‡¶¨‡ßÅ‡¶ù‡¶ø, ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶è‡¶° ‡¶¶‡ßá‡¶ñ‡¶ø‡ßü‡ßá ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßá ‡¶≤‡¶æ‡¶≠ ‡¶π‡¶≤‡ßá, ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶¶‡¶ø‡¶≤‡ßá ‡¶∏‡¶¨‡¶æ‡¶á ‡¶™‡¶æ‡¶¨‡ßá‡•§ ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ ‡¶è‡¶° ‡¶≠‡¶æ‡¶≤‡ßã‡¶≠‡¶æ‡¶¨‡ßá ‡¶®‡¶æ ‡¶¶‡ßá‡¶ñ‡ßá, ‡¶ü‡¶æ‡¶á‡¶Æ‡¶æ‡¶∞ ‡¶∂‡ßá‡¶∑ ‡¶π‡¶ì‡ßü‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá‡¶á ‡¶¨‡ßá‡¶ï ‡¶ö‡¶≤‡ßá ‡¶Ü‡¶∏‡¶æ, 100 ‡¶ü‡¶æ‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡ß¨/‡ß≠ ‡¶ü‡¶ø ‡¶è‡¶°‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶®‡¶æ ‡¶ï‡¶∞‡¶æ, ‡¶è‡¶∞‡¶ï‡¶Æ ‡¶π‡¶≤‡ßá ‡¶§‡ßã ‡¶è‡¶° ‡¶ï‡ßã‡¶Æ‡ßç‡¶™‡¶æ‡¶®‡¶ø ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶¶‡ßá‡ßü ‡¶®‡¶æ‡•§ ‡¶∏‡ßã, ‡¶ì‡¶∞‡¶æ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶®‡¶æ ‡¶¶‡¶ø‡¶≤‡ßá ‡¶¨‡¶ü ‡¶ï‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶¶‡¶ø‡¶¨‡ßá‡•§ ‡¶≠‡¶æ‡¶≤‡ßã ‡¶ï‡¶∞‡¶¨‡ßá‡¶®, ‡¶≠‡¶æ‡¶≤‡ßã ‡¶™‡¶æ‡¶¨‡ßá‡¶®‡•§ ‡¶≠‡¶æ‡¶≤‡ßã‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ø‡¶æ‡¶∞‡¶æ ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶õ‡ßá, ‡¶§‡¶æ‡¶∞‡¶æ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶™‡¶æ‡¶ö‡ßç‡¶õ‡ßá, ‡¶Ü‡¶∞ ‡¶Ø‡¶æ‡¶∞‡¶æ ‡¶≠‡¶æ‡¶≤‡ßã‡¶≠‡¶æ‡¶¨‡ßá ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶õ‡ßá ‡¶®‡¶æ, ‡¶§‡¶æ‡¶∞‡¶æ ‡¶è‡¶° ‡¶¶‡ßá‡¶ñ‡¶≤‡ßá‡¶ì ‡¶Ø‡ßá‡¶π‡ßá‡¶§‡ßÅ ‡¶¨‡¶ü ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶™‡¶æ‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ, ‡¶§‡¶æ‡¶á ‡¶§‡¶æ‡¶∞‡¶æ‡¶ì ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶™‡¶æ‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ‡•§ ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶è‡¶ï‡¶¶‡¶Æ ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞ ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶Ü‡¶õ‡ßá, ‡¶´‡ßá‡¶ï ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶¶‡ßá‡¶∞ ‡¶ß‡¶∞‡¶æ‡¶∞‡•§ ‡¶™‡ßç‡¶≤‡¶ø‡¶ú ‡¶∏‡¶¨‡¶æ‡¶á ‡¶≠‡¶æ‡¶≤‡ßã‡¶≠‡¶æ‡¶¨‡ßá ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p></div>
        <div class="info-card" style="text-align: left;"><h3><i class="fa-solid fa-circle-info"></i> Contact</h3><p>‡¶è‡¶ï ‡¶®‡¶ú‡¶∞‡ßá ‡¶ï‡ßã‡¶•‡¶æ‡ßü ‡¶ï‡ßÄ ‡¶Ü‡¶õ‡ßá?</p><ul><li><b>Mining : </b>‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡ßÆ ‡¶ò‡¶®‡ßç‡¶ü‡¶æ ‡¶™‡¶∞ ‡¶™‡¶∞ ‡¶Æ‡¶æ‡¶á‡¶®‡¶ø‡¶Ç ‡¶ï‡¶∞‡ßá ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ Rix Coin ‡¶ú‡¶Æ‡¶ø‡ßü‡ßá Withdraw ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§</li><li><strong>Task :</strong> ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡ß©‡ß¶‡ß¶‡¶ü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶è‡¶° ‡¶¶‡ßá‡¶ñ‡ßá, ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ RiX Balance ‡¶¨‡¶æ‡ßú‡¶æ‡¶§‡ßá ‡¶™‡¶æ‡ßú‡¶¨‡ßá‡¶®‡•§</li><li><strong>Account : </strong>‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏, ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶°‡¶ø‡¶ü‡ßá‡¶á‡¶≤‡¶∏ ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶® ‡¶è‡¶¨‡¶Ç ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡¶æ‡¶≤ ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ‡¶ì ‡¶™‡¶æ‡¶¨‡ßá‡¶®‡•§</li><li><strong>Withdraw : </strong> ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶â‡¶™‡¶æ‡¶∞‡ßç‡¶ú‡¶ø‡¶§ Rix Coin ‡¶ï‡ßá ‡¶ü‡¶æ‡¶ï‡¶æ‡ßü ‡¶ï‡¶®‡¶≠‡¶æ‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßá, ‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂/‡¶®‡¶ó‡¶¶/‡¶∞‡¶ï‡ßá‡¶ü‡ßá ‡¶§‡ßÅ‡¶≤‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§</li></ul></div>
    </div>
    <!-- Task Section -->
    <div id="task-section" class="main-content">
        <div class="info-card"><h3><i class="fa-solid fa-list-check"></i> Today's Tasks</h3><div class="info-item"><span>Total Tasks</span><span id="total-tasks">300</span></div><div class="info-item"><span>Completed</span><span id="tasks-completed">...</span></div><div class="info-item"><span>Remaining</span><span id="tasks-remaining">...</span></div><button id="start-task-btn" class="main-button" disabled>Watch Ad (+100 RiX)</button></div>
    </div>
    <!-- Account Section -->
    <div id="account-section" class="main-content">
        <div class="info-card">
            <h3><i class="fa-solid fa-user"></i> My Profile</h3>
            <div class="info-item"><span>User Name</span><span id="profile-name">...</span></div> <!-- Typo Fixed -->
            <div class="info-item"><span>User ID</span><span id="profile-id">...</span></div>
            <div class="info-item"><span>Total Balance</span><span id="profile-balance">...</span></div>
            <div class="info-item"><span>Today's Tasks Done</span><span id="profile-tasks-done">...</span></div>
        </div>
        <div id="referral-input-section" class="info-card" style="display: none;">
            <h3><i class="fa-solid fa-gift"></i> Enter Referral Code</h3><p>Get a bonus by entering a friend's code!</p><div class="input-group"><input type="text" id="referral-code-input" placeholder="Enter code here"><button id="submit-referral-btn">Submit</button></div>
        </div>
        <div class="info-card">
            <h3><i class="fa-solid fa-share-nodes"></i> My Referral</h3><div class="info-item"><span>Your Referrals</span><span id="referral-count">0</span></div><div class="input-group"><input type="text" id="referral-link" readonly><button id="copy-btn"><i class="fa-regular fa-copy"></i> Copy</button></div><div id="referral-list-container"><h4>Recent Referrals:</h4><ul id="referral-list"></ul></div>
        </div>
    </div>
    <!-- Withdraw Section -->
    <div id="withdraw-section" class="main-content">
        <div class="info-card withdraw-styles">
            <section class="sct-ax8f3k">
                <h2 class="h-g7k2p">‡¶∏‡¶∞‡ßç‡¶¨‡¶®‡¶ø‡¶Æ‡ßç‡¶® ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ <strong>25,000 Rix Coin</strong></h2>
                <ul class="ul-b4n9s"><li class="li-c7j3d">‚úîÔ∏è 5 Reffer ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá</li><li class="li-c7j3d">‚úîÔ∏è 2 ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶™‡ßÅ‡¶∞‡ßã‡¶®‡ßã ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá</li></ul>
                <div class="div-kLp8xV"><div class="div-rt5j2m"><span class="spn-rix-aB3d1">1,000 Rix</span><span class="spn-taka-fG5h2">‡ß≥ 10</span></div><div class="div-rt5j2m"><span class="spn-rix-aB3d1">10,000 Rix</span><span class="spn-taka-fG5h2">‡ß≥ 150</span></div><div class="div-rt5j2m"><span class="spn-rix-aB3d1">20,000 Rix</span><span class="spn-taka-fG5h2">‡ß≥ 270</span></div><div class="div-rt5j2m"><span class="spn-rix-aB3d1">30,000 Rix</span><span class="spn-taka-fG5h2">‡ß≥ 450</span></div></div>
                <div class="div-w-methods-yv2c6b"><h3>Withdraw Only</h3><div class="div-icn-zT9m4P"><span class="spn-pmt-qW1b8R">bKash</span><span class="spn-pmt-qW1b8R">Rocket</span><span class="spn-pmt-qW1b8R">Nagad</span><span class="spn-pmt-qW1b8R">BTC</span><span class="spn-pmt-qW1b8R">USDT</span><span class="spn-pmt-qW1b8R">Cellfin</span></div></div>
            </section>
        </div>
        <div class="info-card"><h3><i class="fa-solid fa-circle-info"></i> Contact</h3><p>‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ / ‡¶Ö‡¶≠‡¶ø‡¶Ø‡ßã‡¶ó ‡¶ú‡¶æ‡¶®‡¶æ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®, ‡¶è‡¶á ‡¶Ü‡¶á‡¶°‡¶ø‡¶§‡ßá : @forum_support20</p></div>
    </div>
    <!-- Bottom Navigation Bar -->
    <nav class="bottom-nav">
        <button class="nav-button active" data-section="mining-section"><i class="fa-solid fa-person-digging"></i><span>Mining</span></button>
        <button class="nav-button" data-section="task-section"><i class="fa-solid fa-list-check"></i><span>Tasks</span></button>
        <button class="nav-button" data-section="account-section"><i class="fa-solid fa-user"></i><span>Account</span></button>
        <button class="nav-button" data-section="withdraw-section"><i class="fa-solid fa-wallet"></i><span>Withdraw</span></button>
    </nav>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const tg = window.Telegram.WebApp;
            tg.ready(); tg.expand(); tg.setHeaderColor('#171a21');

            const sections = document.querySelectorAll('.main-content');
            const navButtons = document.querySelectorAll('.nav-button');
            const miningClaimBtn = document.getElementById('mining-claim-btn');
            const miningTimerElem = document.getElementById('mining-timer');
            const tasksCompletedElem = document.getElementById('tasks-completed');
            const tasksRemainingElem = document.getElementById('tasks-remaining');
            const startTaskBtn = document.getElementById('start-task-btn');
            const profileNameElem = document.getElementById('profile-name');
            const profileIdElem = document.getElementById('profile-id');
            const profileBalanceElem = document.getElementById('profile-balance');
            const profileTasksDoneElem = document.getElementById('profile-tasks-done');
            const referralInputSection = document.getElementById('referral-input-section');
            const referralCodeInput = document.getElementById('referral-code-input');
            const submitReferralBtn = document.getElementById('submit-referral-btn');
            const referralCountElem = document.getElementById('referral-count');
            const referralLinkInput = document.getElementById('referral-link');
            const copyBtn = document.getElementById('copy-btn');
            const referralListElem = document.getElementById('referral-list');

            let userData = null; let miningInterval;
            const DAILY_TASK_LIMIT = 300; const MINING_COOLDOWN_HOURS = 8;
            
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const sectionId = button.dataset.section;
                    sections.forEach(sec => sec.classList.remove('active'));
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    document.getElementById(sectionId)?.classList.add('active');
                    button.classList.add('active');
                    if (sectionId === 'account-section' && userData) {
                        loadReferrals(userData.user_id);
                    }
                });
            });

            async function loadUserData() {
                if (!tg.initDataUnsafe.user?.id) return showMessage("Authentication Error!", true);
                const user = tg.initDataUnsafe.user;
                const queryParams = new URLSearchParams({ user_id: user.id, first_name: user.first_name, username: user.username });
                try {
                    const response = await fetch(`/api/user_data?${queryParams.toString()}`);
                    if (!response.ok) throw new Error(`Failed to load user data. Status: ${response.status}`);
                    userData = await response.json();
                    updateAllUI();
                } catch (error) { showMessage(error.message, true); }
            }

            function updateAllUI() {
                if (!userData) return;
                const completed = userData.daily_tasks_completed || 0;
                const balance = userData.rix_balance || 0;
                
                if(document.getElementById('total-tasks')) document.getElementById('total-tasks').innerText = DAILY_TASK_LIMIT;
                if (tasksCompletedElem) tasksCompletedElem.innerText = completed;
                if (tasksRemainingElem) tasksRemainingElem.innerText = DAILY_TASK_LIMIT - completed;
                if (startTaskBtn) {
                    startTaskBtn.disabled = completed >= DAILY_TASK_LIMIT;
                    startTaskBtn.innerText = completed >= DAILY_TASK_LIMIT ? "All Tasks Done" : "Watch Ad (+100 RiX)";
                }
                if (profileNameElem) profileNameElem.innerText = userData.first_name;
                if (profileIdElem) profileIdElem.innerText = userData.user_id;
                if (profileBalanceElem) profileBalanceElem.innerText = formatBalance(balance) + ' RiX';
                if (profileTasksDoneElem) profileTasksDoneElem.innerText = `${completed} / ${DAILY_TASK_LIMIT}`;
                if (referralLinkInput) {
                    const botUsername = "Rix_earn_bot";
                    referralLinkInput.value = `https://t.me/${botUsername}?start=${userData.referral_code}`;
                }
                if (referralInputSection) {
                    referralInputSection.style.display = (userData.referred_by === null) ? 'block' : 'none';
                }
                updateMiningStatus();
            }

            function updateMiningStatus() {
                if (!userData || !miningClaimBtn) return;
                const lastClaimTime = userData.last_mining_claim ? new Date(userData.last_mining_claim) : null;
                if (miningInterval) clearInterval(miningInterval);
                if (!lastClaimTime) {
                    miningClaimBtn.disabled = false; miningClaimBtn.innerText = "Claim Mining Reward";
                    miningTimerElem.innerText = "Ready to claim!"; return;
                }
                const nextClaimTime = new Date(lastClaimTime.getTime() + MINING_COOLDOWN_HOURS * 60 * 60 * 1000);
                function updateTimer() {
                    const now = new Date(); const timeLeft = nextClaimTime - now;
                    if (timeLeft <= 0) {
                        miningClaimBtn.disabled = false; miningClaimBtn.innerText = "Claim Mining Reward";
                        miningTimerElem.innerText = "Ready to claim!"; clearInterval(miningInterval);
                    } else {
                        miningClaimBtn.disabled = true; miningClaimBtn.innerText = "Mining...";
                        const h = Math.floor(timeLeft / 3600000), m = Math.floor((timeLeft % 3600000) / 60000), s = Math.floor((timeLeft % 60000) / 1000);
                        miningTimerElem.innerText = `Next claim in: ${pad(h)}:${pad(m)}:${pad(s)}`;
                    }
                }
                updateTimer();
                miningInterval = setInterval(updateTimer, 1000);
            }
            
            async function loadReferrals(userId) {
                if (!referralListElem) return;
                referralListElem.innerHTML = '<li>Loading...</li>';
                const response = await fetch(`/api/get_referrals?user_id=${userId}`);
                const referrals = await response.json();
                referralCountElem.innerText = referrals.length;
                referralListElem.innerHTML = '';
                if (referrals.length === 0) { referralListElem.innerHTML = '<li>No referrals yet.</li>'; return; }
                referrals.forEach(ref => {
                    const li = document.createElement('li');
                    const date = new Date(ref.created_at).toLocaleDateString("en-GB");
                    li.innerText = `${ref.first_name} - Joined on ${date}`;
                    referralListElem.appendChild(li);
                });
            }

            function showMonetagAd() {
                return new Promise((resolve, reject) => {
                    if (typeof show_9504423 === 'function') {
                        show_9504423().then(() => resolve(true)).catch(error => reject(error));
                    } else { reject(new Error("Ad service not available.")); }
                });
            }

            if(startTaskBtn) startTaskBtn.addEventListener('click', async () => {
                if (startTaskBtn.disabled) return;
                startTaskBtn.disabled = true; startTaskBtn.innerText = "Loading Ad...";
                try {
                    await showMonetagAd();
                    const response = await fetch('/api/complete_task', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: tg.initDataUnsafe.user.id }) });
                    const result = await response.json();
                    if (result.success) {
                        tg.HapticFeedback.notificationOccurred('success');
                        showMessage(result.message); userData = result.user_data; updateAllUI();
                    } else { showMessage(result.message || "Task failed.", true); updateAllUI(); }
                } catch (error) {
                    showMessage("Ad could not be shown. Please try again.", true);
                    startTaskBtn.disabled = false; startTaskBtn.innerText = "Watch Ad (+100 RiX)";
                }
            });
            
            if(miningClaimBtn) miningClaimBtn.addEventListener('click', async () => {
                if (!userData) return showMessage("User data not loaded.", true);
                miningClaimBtn.disabled = true; miningClaimBtn.innerText = "Claiming...";
                try {
                    const response = await fetch('/api/claim_mining', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: userData.user_id }) });
                    const result = await response.json();
                    if (result.success) {
                        tg.HapticFeedback.notificationOccurred('success');
                        showMessage(result.message); userData = result.user_data; updateAllUI();
                    } else { showMessage(result.message, true); updateMiningStatus(); }
                } catch (error) { showMessage("An error occurred.", true); }
            });

            if(copyBtn) copyBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(referralLinkInput.value).then(() => showMessage('Referral link copied!'));
            });

            if(submitReferralBtn) submitReferralBtn.addEventListener('click', async () => {
                const code = referralCodeInput.value;
                if (!code) return showMessage("Please enter a referral code.", true);
                submitReferralBtn.disabled = true; submitReferralBtn.innerText = "Submitting...";
                try {
                    const response = await fetch('/api/submit_referral', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: userData.user_id, referral_code: code }) });
                    const result = await response.json();
                    if (result.success) {
                        showMessage(result.message);
                        userData = result.user_data; updateAllUI();
                    } else { showMessage(result.message || "Failed to submit code.", true); }
                } catch (error) { showMessage("An error occurred.", true);
                } finally { submitReferralBtn.disabled = false; submitReferralBtn.innerText = "Submit"; }
            });

            function formatBalance(num) { return new Intl.NumberFormat().format(Math.floor(num)); }
            function pad(n) { return n < 10 ? '0' + n : n; }
            function showMessage(message, isError = false) {
                tg.showAlert(message);
            }
            
            loadUserData();
        });
    </script>
</body>
</html>
