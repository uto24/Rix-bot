<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>RiX Earn</title>
    
    <!-- Font Awesome আইকনের জন্য CDN লিঙ্ক -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- Monetag SDK লোড করার জন্য -->
    <script src='//libtl.com/sdk.js' data-zone='9504423' data-sdk='show_9504423'></script>

    <style>
        :root { --tg-theme-bg-color: #171a21; --tg-theme-text-color: #e0e0e0; --tg-theme-button-color: #5288c1; --tg-theme-button-text-color: #ffffff; --tg-theme-hint-color: #9099a2; --tg-theme-secondary-bg-color: #2a2c3c; --primary-accent-color: #4a90e2; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .main-content { flex-grow: 1; padding: 20px; overflow-y: auto; display: none; text-align: center; }
        .main-content.active { display: flex; flex-direction: column; align-items: center; }
        .info-card { background-color: var(--tg-theme-secondary-bg-color); border-radius: 12px; padding: 20px; margin-bottom: 15px; width: 90%; max-width: 400px; }
        .info-card h3 { margin-top: 0; color: var(--primary-accent-color); display: flex; align-items: center; justify-content: center; gap: 8px; }
        .info-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #3a3c4c; }
        .info-item:last-child { border-bottom: none; }
        .input-group { display: flex; align-items: center; margin-top: 10px; }
        .input-group input { flex-grow: 1; background-color: #3a3c4c; border: 1px solid #555; color: white; padding: 10px; border-radius: 8px 0 0 8px; font-size: 0.9em; }
        .input-group button { background-color: var(--primary-accent-color); border: none; color: white; padding: 11px 15px; border-radius: 0 8px 8px 0; cursor: pointer; }
        #referral-list-container { margin-top: 20px; text-align: left; }
        #referral-list { list-style-type: none; padding: 0; max-height: 150px; overflow-y: auto; }
        #referral-list li { background-color: #3a3c4c; padding: 8px 12px; border-radius: 6px; margin-bottom: 5px; font-size: 0.9em; }
        .main-button { width: 100%; background-color: var(--tg-theme-button-color); color: white; border: none; padding: 15px 0; font-size: 1.1em; font-weight: bold; border-radius: 10px; cursor: pointer; margin-top: 10px; }
        .main-button:disabled { background-color: #555; cursor: not-allowed; }
        .bottom-nav { width: 100%; display: flex; justify-content: space-around; padding: 10px 0; background-color: var(--tg-theme-secondary-bg-color); border-top: 1px solid #3a3c4c; }
        .nav-button { background: none; border: none; color: var(--tg-theme-hint-color); cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 0.8em; }
        .nav-button.active { color: var(--primary-accent-color); }
        .nav-button i { font-size: 1.5em; }
    </style>
</head>
<body>
    <!-- Mining Section -->
    <div id="mining-section" class="main-content active">
        <div class="info-card"><h3><i class="fa-solid fa-person-digging"></i> Mining Hub</h3><p>Claim reward every 8 hours!</p><button id="mining-claim-btn" class="main-button" disabled>Loading...</button><p id="mining-timer" class="timer-text">...</p></div>
    </div>
    <!-- Task Section -->
    <div id="task-section" class="main-content">
        <div class="info-card"><h3><i class="fa-solid fa-list-check"></i> Today's Tasks</h3><div class="info-item"><span>Total Tasks</span><span>100</span></div><div class="info-item"><span>Completed</span><span id="tasks-completed">...</span></div><button id="start-task-btn" class="main-button" disabled>Watch Ad (+200 RiX)</button></div>
    </div>
    <!-- Account Section -->
    <div id="account-section" class="main-content">
        <div class="info-card">
            <h3><i class="fa-solid fa-user"></i> My Profile</h3>
            <div class="info-item"><span>User Name</span><span id="profile-name">...</span></div>
            <div class="info-item"><span>Total Balance</span><span id="profile-balance">...</span></div>
            <div class="info-item"><span>Today's Tasks Done</span><span id="profile-tasks-done">...</span></div>
        </div>
        <div id="referral-input-section" class="info-card" style="display: none;">
            <h3><i class="fa-solid fa-gift"></i> Enter Referral Code</h3>
            <p>Get a bonus by entering a friend's code!</p>
            <div class="input-group">
                <input type="text" id="referral-code-input" placeholder="Enter code here">
                <button id="submit-referral-btn">Submit</button>
            </div>
        </div>
        <div class="info-card">
            <h3><i class="fa-solid fa-share-nodes"></i> My Referral</h3>
            <div class="info-item"><span>Your Referrals</span><span id="referral-count">0</span></div>
            <div class="input-group">
                <input type="text" id="referral-link" readonly>
                <button id="copy-btn"><i class="fa-regular fa-copy"></i> Copy</button>
            </div>
            <div id="referral-list-container">
                <h4>Recent Referrals:</h4>
                <ul id="referral-list"></ul>
            </div>
        </div>
    </div>
    <!-- Withdraw Section -->
    <div id="withdraw-section" class="main-content">
         <div class="info-card"><h3><i class="fa-solid fa-wallet"></i> Withdraw RiX</h3><p>Withdrawal feature is under development.</p></div>
    </div>
    <!-- Bottom Navigation Bar -->
    <div class="bottom-nav">
        <button class="nav-button active" data-section="mining-section"><i class="fa-solid fa-person-digging"></i><span>Mining</span></button>
        <button class="nav-button" data-section="task-section"><i class="fa-solid fa-list-check"></i><span>Tasks</span></button>
        <button class="nav-button" data-section="account-section"><i class="fa-solid fa-user"></i><span>Account</span></button>
        <button class="nav-button" data-section="withdraw-section"><i class="fa-solid fa-wallet"></i><span>Withdraw</span></button>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const tg = window.Telegram.WebApp;
            tg.ready(); tg.expand();

            const sections = document.querySelectorAll('.main-content');
            const navButtons = document.querySelectorAll('.nav-button');
            const startTaskBtn = document.getElementById('start-task-btn');
            const miningClaimBtn = document.getElementById('mining-claim-btn');
            const copyBtn = document.getElementById('copy-btn');
            const referralListElem = document.getElementById('referral-list');
            const referralCountElem = document.getElementById('referral-count');
            const referralInputSection = document.getElementById('referral-input-section');
            const submitReferralBtn = document.getElementById('submit-referral-btn');
            const referralCodeInput = document.getElementById('referral-code-input');
            
            let userData = null; let miningInterval;
            const DAILY_TASK_LIMIT = 100; const MINING_COOLDOWN_HOURS = 8;
            
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const sectionId = button.dataset.section;
                    sections.forEach(sec => sec.classList.remove('active'));
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    document.getElementById(sectionId).classList.add('active');
                    button.classList.add('active');
                    if (sectionId === 'account-section' && userData) {
                        loadReferrals(userData.user_id);
                    }
                });
            });

            async function loadUserData() {
                if (!tg.initDataUnsafe.user?.id) return showError("Authentication Error!");
                const user = tg.initDataUnsafe.user;
                const queryParams = new URLSearchParams({ user_id: user.id, first_name: user.first_name, username: user.username });
                try {
                    const response = await fetch(`/api/user_data?${queryParams.toString()}`);
                    if (!response.ok) throw new Error('Failed to load user data.');
                    userData = await response.json();
                    updateAllUI();
                } catch (error) { showError(error.message); }
            }

            function updateAllUI() {
                if (!userData) return;
                const completed = userData.daily_tasks_completed || 0;
                const balance = userData.rix_balance || 0;
                
                document.getElementById('tasks-completed').innerText = completed;
                document.getElementById('tasks-remaining').innerText = DAILY_TASK_LIMIT - completed;
                startTaskBtn.disabled = completed >= DAILY_TASK_LIMIT;
                startTaskBtn.innerText = completed >= DAILY_TASK_LIMIT ? "All Tasks Done" : "Watch Ad (+200 RiX)";
                
                document.getElementById('profile-name').innerText = userData.first_name;
                document.getElementById('profile-balance').innerText = formatBalance(balance) + ' RiX';
                document.getElementById('profile-tasks-done').innerText = `${completed} / ${DAILY_TASK_LIMIT}`;
                
                const botUsername = "Rix_earn_bot";
                document.getElementById('referral-link').value = `https://t.me/${botUsername}?start=${userData.referral_code}`;
                
                if (userData.referred_by === null) {
                    referralInputSection.style.display = 'block';
                } else {
                    referralInputSection.style.display = 'none';
                }
                updateMiningStatus();
            }

            function updateMiningStatus() { /* ... (আগের উত্তর থেকে সম্পূর্ণ কোড) ... */ }
            async function loadReferrals(userId) { /* ... (আগের উত্তর থেকে সম্পূর্ণ কোড) ... */ }
            function showMonetagAd() { /* ... (আগের উত্তর থেকে সম্পূর্ণ কোড) ... */ }
            
            startTaskBtn.addEventListener('click', async () => { /* ... (আগের উত্তর থেকে সম্পূর্ণ কোড) ... */ });
            miningClaimBtn.addEventListener('click', async () => { /* ... (আগের উত্তর থেকে সম্পূর্ণ কোড) ... */ });
            copyBtn.addEventListener('click', () => { /* ... (আগের উত্তর থেকে সম্পূর্ণ কোড) ... */ });

            submitReferralBtn.addEventListener('click', async () => {
                const code = referralCodeInput.value;
                if (!code) return showError("Please enter a referral code.");
                submitReferralBtn.disabled = true; submitReferralBtn.innerText = "Submitting...";
                try {
                    const response = await fetch('/api/submit_referral', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_id: userData.user_id, referral_code: code })
                    });
                    const result = await response.json();
                    if (result.success) {
                        tg.showAlert(result.message);
                        userData = result.user_data;
                        updateAllUI();
                    } else {
                        showError(result.message || "Failed to submit code.");
                    }
                } catch (error) { showError("An error occurred.");
                } finally { submitReferralBtn.disabled = false; submitReferralBtn.innerText = "Submit"; }
            });

            function formatBalance(num) { return new Intl.NumberFormat().format(Math.floor(num)); }
            function showError(message) { tg.showAlert(message); }
            
            loadUserData();
        });
    </script>
</body>
</html>
