<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>RiX Earn</title>
    
    <!-- Font Awesome আইকনের জন্য CDN লিঙ্ক -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        /* --- General Styles (Dark Theme) --- */
        :root {
            --tg-theme-bg-color: #171a21;
            --tg-theme-text-color: #e0e0e0;
            --tg-theme-button-color: #5288c1;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-hint-color: #9099a2;
            --tg-theme-secondary-bg-color: #2a2c3c;
            --primary-accent-color: #4a90e2;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Main Content Area --- */
        .main-content {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: none; /* Initially hide all sections */
        }
        .main-content.active {
            display: block; /* Show active section */
        }

        /* --- Mining Section --- */
        #mining-section .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        .coin-display {
            display: flex; flex-direction: column; align-items: center; margin-bottom: 30px;
        }
        .coin-icon {
            width: 100px; height: 100px; animation: spin 5s linear infinite;
        }
        #balance {
            font-size: 2.5em; font-weight: bold; margin-top: 15px;
        }
        #claim-button {
            width: 80%; max-width: 300px; background-color: var(--primary-accent-color); color: white; border: none; padding: 18px 0; font-size: 1.2em; font-weight: bold; border-radius: 12px; cursor: pointer; transition: all 0.2s ease;
        }
        #claim-button:disabled {
            background-color: #3e4d58; cursor: not-allowed;
        }
        #timer {
            margin-top: 15px; font-size: 1em; color: var(--tg-theme-hint-color);
        }

        /* --- Account & Task & Withdraw Sections --- */
        .info-card {
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }
        .info-card h3 {
            margin-top: 0;
            color: var(--primary-accent-color);
        }
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #3a3c4c;
        }
        .info-item:last-child {
            border-bottom: none;
        }
        .info-item span:first-child {
            color: var(--tg-theme-hint-color);
        }
        .info-item span:last-child {
            font-weight: bold;
        }
        .referral-link-container {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        #referral-link {
            flex-grow: 1; background-color: #3a3c4c; border: none; color: white; padding: 10px; border-radius: 8px 0 0 8px; font-size: 0.9em;
        }
        #copy-btn {
            background-color: var(--primary-accent-color); border: none; color: white; padding: 10px 15px; border-radius: 0 8px 8px 0; cursor: pointer; font-size: 0.9em;
        }
        .task {
            display: flex; justify-content: space-between; align-items: center; padding: 15px;
        }

        /* --- Bottom Navigation --- */
        .bottom-nav {
            width: 100%; display: flex; justify-content: space-around; padding: 10px 0; background-color: var(--tg-theme-secondary-bg-color); border-top: 1px solid #3a3c4c;
        }
        .nav-button {
            background: none; border: none; color: var(--tg-theme-hint-color); cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 0.8em; transition: color 0.2s ease;
        }
        .nav-button.active {
            color: var(--primary-accent-color);
        }
        .nav-button i {
            font-size: 1.5em;
        }

        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <!-- Mining Section -->
    <div id="mining-section" class="main-content active">
        <div class="container">
            <div class="coin-display">
                <img src="https://i.ibb.co/Y0K2A5T/rix-coin.png" alt="RiX Coin" class="coin-icon">
                <span id="balance">...</span>
            </div>
            <button id="claim-button" disabled>Loading...</button>
            <p id="timer">...</p>
        </div>
    </div>

    <!-- Task Section -->
    <div id="task-section" class="main-content">
        <div class="info-card">
            <h3>Daily Tasks</h3>
            <div class="task">
                <span>Watch an Ad (+100 RiX)</span>
                <button id="ad-watch-btn" class="claim-button-small">Watch</button>
            </div>
             <div class="task">
                <span>Follow us on X (+500 RiX)</span>
                <button onclick="window.open('https://x.com/telegram', '_blank')" class="claim-button-small">Follow</button>
            </div>
        </div>
    </div>

    <!-- Account Section -->
    <div id="account-section" class="main-content">
        <div class="info-card">
            <h3>My Profile</h3>
            <div class="info-item"><span>User Name</span><span id="profile-name">...</span></div>
            <div class="info-item"><span>User ID</span><span id="profile-id">...</span></div>
            <div class="info-item"><span>Total Balance</span><span id="profile-balance">...</span></div>
        </div>
        <div class="info-card">
            <h3>Referral</h3>
            <div class="referral-link-container">
                <input type="text" id="referral-link" readonly>
                <button id="copy-btn"><i class="fa-regular fa-copy"></i></button>
            </div>
        </div>
    </div>

    <!-- Withdraw Section -->
    <div id="withdraw-section" class="main-content">
         <div class="info-card">
            <h3>Withdraw RiX</h3>
            <p>Withdrawal feature is under development. It will be available soon!</p>
            <p style="color: var(--tg-theme-hint-color);">Minimum withdrawal: 100,000 RiX</p>
        </div>
    </div>

    <!-- Bottom Navigation Bar -->
    <div class="bottom-nav">
        <button class="nav-button active" data-section="mining-section"><i class="fa-solid fa-person-digging"></i><span>Mining</span></button>
        <button class="nav-button" data-section="task-section"><i class="fa-solid fa-list-check"></i><span>Tasks</span></button>
        <button class="nav-button" data-section="account-section"><i class="fa-solid fa-user"></i><span>Account</span></button>
        <button class="nav-button" data-section="withdraw-section"><i class="fa-solid fa-wallet"></i><span>Withdraw</span></button>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        tg.setHeaderColor('#171a21');

        // DOM Elements
        const sections = document.querySelectorAll('.main-content');
        const navButtons = document.querySelectorAll('.nav-button');
        const claimButton = document.getElementById('claim-button');
        const balanceElem = document.getElementById('balance');
        const timerElem = document.getElementById('timer');
        const copyBtn = document.getElementById('copy-btn');
        
        let claimInterval;
        let userData = null;
        const MINING_INTERVAL_HOURS = 6;

        // --- Navigation Logic ---
        function switchSection(sectionId) {
            sections.forEach(sec => sec.classList.remove('active'));
            navButtons.forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(sectionId).classList.add('active');
            document.querySelector(`.nav-button[data-section="${sectionId}"]`).classList.add('active');
        }

        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                switchSection(button.dataset.section);
                tg.HapticFeedback.impactOccurred('light');
            });
        });

        // --- Data Loading and UI Update ---
        async function loadUserData() {
            if (!tg.initDataUnsafe.user || !tg.initDataUnsafe.user.id) {
                showError("User authentication failed. Please restart the app.");
                return;
            }
            const user = tg.initDataUnsafe.user;
            const queryParams = new URLSearchParams({
                user_id: user.id, first_name: user.first_name || 'Player', username: user.username || ''
            });
            
            try {
                const response = await fetch(`/api/user_data?${queryParams.toString()}`);
                if (!response.ok) throw new Error('Failed to fetch user data');
                userData = await response.json();
                updateAllUI(userData);
            } catch (error) { showError(error.message); }
        }

        function updateAllUI(data) {
            if (!data) return;
            // Mining Section
            balanceElem.innerText = formatBalance(data.rix_balance);
            updateMiningStatus(data);
            // Account Section
            document.getElementById('profile-name').innerText = data.first_name;
            document.getElementById('profile-id').innerText = data.user_id;
            document.getElementById('profile-balance').innerText = formatBalance(data.rix_balance) + ' RiX';
            const botUsername = "Rix_earn_bot"; // এখানে আপনার বটের ইউজারনেম দিন
            document.getElementById('referral-link').value = `https://t.me/${botUsername}?start=${data.referral_code}`;
        }
        
        function updateMiningStatus(data) {
            const lastClaimTime = data.last_mining_claim ? new Date(data.last_mining_claim) : null;
            if (claimInterval) clearInterval(claimInterval);
            
            if (!lastClaimTime) {
                claimButton.disabled = false; claimButton.innerText = "Claim Reward";
                timerElem.innerText = "Ready to claim your first reward!";
                return;
            }

            const nextClaimTime = new Date(lastClaimTime.getTime() + MINING_INTERVAL_HOURS * 60 * 60 * 1000);
            
            function updateTimer() {
                const now = new Date();
                const timeLeft = nextClaimTime - now;
                if (timeLeft <= 0) {
                    claimButton.disabled = false; claimButton.innerText = "Claim Reward";
                    timerElem.innerText = "Ready to claim!";
                    clearInterval(claimInterval);
                } else {
                    claimButton.disabled = true; claimButton.innerText = "Mining...";
                    const h = Math.floor(timeLeft / 3600000);
                    const m = Math.floor((timeLeft % 3600000) / 60000);
                    const s = Math.floor((timeLeft % 60000) / 1000);
                    timerElem.innerText = `Next claim in: ${pad(h)}:${pad(m)}:${pad(s)}`;
                }
            }
            updateTimer();
            claimInterval = setInterval(updateTimer, 1000);
        }

        // --- Event Listeners ---
        claimButton.addEventListener('click', async () => {
            if (!tg.initDataUnsafe.user) return showError("User not authenticated.");
            claimButton.disabled = true; claimButton.innerText = "Claiming...";
            tg.HapticFeedback.impactOccurred('light');

            try {
                const response = await fetch('/api/claim_reward', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: tg.initDataUnsafe.user.id })
                });
                const result = await response.json();
                if (result.success) {
                    tg.HapticFeedback.notificationOccurred('success');
                    userData = result.user_data;
                    updateAllUI(userData);
                } else {
                    showError(result.message || "Failed to claim.");
                    loadUserData();
                }
            } catch (error) { showError("An error occurred."); loadUserData(); }
        });

        copyBtn.addEventListener('click', () => {
            const linkInput = document.getElementById('referral-link');
            navigator.clipboard.writeText(linkInput.value).then(() => {
                tg.HapticFeedback.notificationOccurred('success');
                alert('Referral link copied!');
            }, () => {
                showError('Failed to copy link.');
            });
        });

        // --- Helper Functions ---
        function formatBalance(num) { return new Intl.NumberFormat().format(Math.floor(num)); }
        function pad(n) { return n < 10 ? '0' + n : n; }
        function showError(message) { tg.showAlert(message); }

        // Initial Load
        loadUserData();
        switchSection('mining-section');

    </script>
</body>
</html>
