<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>RiX Earn</title>
    
    <!-- Font Awesome আইকনের জন্য CDN লিঙ্ক -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- Monetag SDK লোড করার জন্য -->
    <!-- আপনার জোন আইডি (9504423) এখানে সঠিক আছে কিনা তা নিশ্চিত করুন -->
    <script src='//libtl.com/sdk.js' data-zone='9504423' data-sdk='show_9504423'></script>

    <style>
        :root { --tg-theme-bg-color: #171a21; --tg-theme-text-color: #e0e0e0; --tg-theme-button-color: #5288c1; --tg-theme-button-text-color: #ffffff; --tg-theme-hint-color: #9099a2; --tg-theme-secondary-bg-color: #2a2c3c; --primary-accent-color: #4a90e2; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .main-content { flex-grow: 1; padding: 20px; overflow-y: auto; display: none; }
        .main-content.active { display: block; }
        .info-card { background-color: var(--tg-theme-secondary-bg-color); border-radius: 12px; padding: 20px; margin-bottom: 15px; }
        .info-card h3 { margin-top: 0; color: var(--primary-accent-color); }
        .info-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #3a3c4c; }
        .info-item:last-child { border-bottom: none; }
        .info-item span:first-child { color: var(--tg-theme-hint-color); }
        .info-item span:last-child { font-weight: bold; }
        #start-task-btn { width: 100%; background-color: var(--tg-theme-button-color); color: white; border: none; padding: 15px 0; font-size: 1.1em; font-weight: bold; border-radius: 10px; cursor: pointer; margin-top: 10px; }
        #start-task-btn:disabled { background-color: #555; cursor: not-allowed; }
        .bottom-nav { width: 100%; display: flex; justify-content: space-around; padding: 10px 0; background-color: var(--tg-theme-secondary-bg-color); border-top: 1px solid #3a3c4c; }
        .nav-button { background: none; border: none; color: var(--tg-theme-hint-color); cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 0.8em; }
        .nav-button.active { color: var(--primary-accent-color); }
        .nav-button i { font-size: 1.5em; }
    </style>
</head>
<body>
    <!-- Mining Section -->
    <div id="mining-section" class="main-content">
        <div class="info-card"><h3>Mining Hub</h3><p>This feature is a work in progress. Come back later!</p></div>
    </div>
    <!-- Task Section -->
    <div id="task-section" class="main-content">
        <div class="info-card">
            <h3>Today's Tasks</h3>
            <div class="info-item"><span>Total Tasks</span><span id="total-tasks">100</span></div>
            <div class="info-item"><span>Completed</span><span id="tasks-completed">...</span></div>
            <div class="info-item"><span>Remaining</span><span id="tasks-remaining">...</span></div>
            <button id="start-task-btn" disabled>Watch Ad (+200 RiX)</button>
        </div>
    </div>
    <!-- Account Section -->
    <div id="account-section" class="main-content">
        <div class="info-card">
            <h3>My Profile</h3>
            <div class="info-item"><span>User Name</span><span id="profile-name">...</span></div>
            <div class="info-item"><span>Total Balance</span><span id="profile-balance">...</span></div>
            <div class="info-item"><span>Today's Tasks Done</span><span id="profile-tasks-done">...</span></div>
        </div>
    </div>
    <!-- Withdraw Section -->
    <div id="withdraw-section" class="main-content">
         <div class="info-card"><h3>Withdraw RiX</h3><p>Withdrawal feature is under development.</p></div>
    </div>
    <!-- Bottom Navigation Bar -->
    <div class="bottom-nav">
        <button class="nav-button active" data-section="mining-section"><i class="fa-solid fa-person-digging"></i><span>Mining</span></button>
        <button class="nav-button" data-section="task-section"><i class="fa-solid fa-list-check"></i><span>Tasks</span></button>
        <button class="nav-button" data-section="account-section"><i class="fa-solid fa-user"></i><span>Account</span></button>
        <button class="nav-button" data-section="withdraw-section"><i class="fa-solid fa-wallet"></i><span>Withdraw</span></button>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // DOM Elements
        const sections = document.querySelectorAll('.main-content');
        const navButtons = document.querySelectorAll('.nav-button');
        const startTaskBtn = document.getElementById('start-task-btn');
        
        let userData = null;
        const DAILY_TASK_LIMIT = 100;

        // Navigation Logic
        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                const sectionId = button.dataset.section;
                sections.forEach(sec => sec.classList.remove('active'));
                navButtons.forEach(btn => btn.classList.remove('active'));
                document.getElementById(sectionId).classList.add('active');
                button.classList.add('active');
            });
        });

        // Data Loading with detailed logging for debugging
        async function loadUserData() {
            if (!tg.initDataUnsafe.user?.id) {
                return showError("Critical Error: User authentication failed.");
            }
            const user = tg.initDataUnsafe.user;
            const queryParams = new URLSearchParams({ user_id: user.id, first_name: user.first_name || 'Player', username: user.username || '' });
            const apiUrl = `/api/user_data?${queryParams.toString()}`;
            
            console.log("Attempting to fetch data from:", apiUrl);

            try {
                const response = await fetch(apiUrl);
                console.log("Fetch response received. Status:", response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("Server Error Response:", errorText);
                    throw new Error(`Failed to load data. Server responded with status ${response.status}`);
                }
                
                const data = await response.json();
                console.log("Successfully fetched and parsed user data:", data);
                userData = data;
                updateAllUI();
            } catch (error) {
                console.error("Error in loadUserData catch block:", error);
                showError(error.message);
            }
        }

        // Update all UI elements with new data
        function updateAllUI() {
            if (!userData) return;
            const completed = userData.daily_tasks_completed || 0;
            const balance = userData.rix_balance || 0;
            
            // Task Section
            document.getElementById('tasks-completed').innerText = completed;
            document.getElementById('tasks-remaining').innerText = DAILY_TASK_LIMIT - completed;
            startTaskBtn.disabled = completed >= DAILY_TASK_LIMIT;
            startTaskBtn.innerText = completed >= DAILY_TASK_LIMIT ? "All Tasks Done" : "Watch Ad (+200 RiX)";
            
            // Account Section
            document.getElementById('profile-name').innerText = userData.first_name;
            document.getElementById('profile-balance').innerText = new Intl.NumberFormat().format(balance) + ' RiX';
            document.getElementById('profile-tasks-done').innerText = `${completed} / ${DAILY_TASK_LIMIT}`;
        }
        
        // Task Button Click Event
        startTaskBtn.addEventListener('click', () => {
            if (startTaskBtn.disabled) return;
            startTaskBtn.disabled = true;
            startTaskBtn.innerText = "Loading Ad...";
            tg.HapticFeedback.impactOccurred('light');

            try {
                // Monetag Rewarded Interstitial অ্যাড দেখান
                show_9504423().then(() => {
                    // বিজ্ঞাপন দেখার পর এই কোডটি চলবে
                    claimTaskReward();
                }).catch(error => {
                    console.error("Monetag Ad error:", error);
                    showError("Ad could not be shown. Please try again.");
                    startTaskBtn.disabled = false;
                    startTaskBtn.innerText = "Watch Ad (+200 RiX)";
                });
            } catch (e) {
                 console.error("Error calling show_9504423:", e);
                 showError("Ad SDK failed to load. Please check your connection.");
                 startTaskBtn.disabled = false;
                 startTaskBtn.innerText = "Watch Ad (+200 RiX)";
            }
        });

        // Claim reward from server
        async function claimTaskReward() {
            try {
                const response = await fetch('/api/complete_task', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: tg.initDataUnsafe.user.id })
                });
                const result = await response.json();
                if (result.success) {
                    tg.HapticFeedback.notificationOccurred('success');
                    tg.showAlert(result.message);
                    userData = result.user_data;
                    updateAllUI();
                } else {
                    showError(result.message || "Task could not be completed.");
                    updateAllUI(); // Update UI even on failure (e.g., tasks exhausted)
                }
            } catch (error) {
                showError("An error occurred while claiming reward.");
                startTaskBtn.disabled = false;
                startTaskBtn.innerText = "Watch Ad (+200 RiX)";
            }
        }

        // Helper function to show alerts
        function showError(message) {
            tg.showAlert(message);
        }

        // Initial Load and Section Setup
        loadUserData();
        document.getElementById('mining-section').classList.add('active');

    </script>
</body>
</html>
