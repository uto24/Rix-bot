<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>RiX Earn</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root { --tg-theme-bg-color: #171a21; --tg-theme-text-color: #e0e0e0; --tg-theme-button-color: #5288c1; --tg-theme-button-text-color: #ffffff; --tg-theme-hint-color: #9099a2; --tg-theme-secondary-bg-color: #2a2c3c; --primary-accent-color: #4a90e2; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .main-content { flex-grow: 1; padding: 20px; overflow-y: auto; display: none; text-align: center; }
        .main-content.active { display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .info-card { background-color: var(--tg-theme-secondary-bg-color); border-radius: 12px; padding: 20px; margin-bottom: 15px; width: 90%; max-width: 400px; }
        .info-card h3 { margin-top: 0; color: var(--primary-accent-color); display: flex; align-items: center; justify-content: center; gap: 8px; }
        .info-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #3a3c4c; }
        .info-item:last-child { border-bottom: none; }
        .referral-link-container { display: flex; align-items: center; margin-top: 10px; }
        #referral-link { flex-grow: 1; background-color: #3a3c4c; border: none; color: white; padding: 10px; border-radius: 8px 0 0 8px; font-size: 0.9em; }
        #copy-btn { background-color: var(--primary-accent-color); border: none; color: white; padding: 10px 15px; border-radius: 0 8px 8px 0; cursor: pointer; font-size: 0.9em; }
        .main-button { width: 100%; background-color: var(--tg-theme-button-color); color: white; border: none; padding: 15px 0; font-size: 1.1em; font-weight: bold; border-radius: 10px; cursor: pointer; margin-top: 10px; }
        .main-button:disabled { background-color: #555; cursor: not-allowed; }
        .timer-text { margin-top: 15px; font-size: 1em; color: var(--tg-theme-hint-color); }
        .bottom-nav { width: 100%; display: flex; justify-content: space-around; padding: 10px 0; background-color: var(--tg-theme-secondary-bg-color); border-top: 1px solid #3a3c4c; }
        .nav-button { background: none; border: none; color: var(--tg-theme-hint-color); cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 0.8em; }
        .nav-button.active { color: var(--primary-accent-color); }
        .nav-button i { font-size: 1.5em; }
    </style>
</head>
<body>
    <!-- Mining Section -->
    <div id="mining-section" class="main-content active">
        <div class="info-card">
            <h3><i class="fa-solid fa-person-digging"></i> Mining Hub</h3>
            <p>Claim your mining reward every 8 hours!</p>
            <button id="mining-claim-btn" class="main-button" disabled>Loading...</button>
            <p id="mining-timer" class="timer-text">...</p>
        </div>
    </div>
    <!-- Task Section -->
    <div id="task-section" class="main-content">
        <div class="info-card">
            <h3><i class="fa-solid fa-list-check"></i> Today's Tasks</h3>
            <div class="info-item"><span>Total Tasks</span><span id="total-tasks">100</span></div>
            <div class="info-item"><span>Completed</span><span id="tasks-completed">...</span></div>
            <button id="start-task-btn" class="main-button" disabled>Watch Ad (+200 RiX)</button>
        </div>
    </div>
    <!-- Account Section -->
    <div id="account-section" class="main-content">
        <div class="info-card">
            <h3><i class="fa-solid fa-user"></i> My Profile</h3>
            <div class="info-item"><span>User Name</span><span id="profile-name">...</span></div>
            <div class="info-item"><span>Total Balance</span><span id="profile-balance">...</span></div>
            <div class="info-item"><span>Today's Tasks Done</span><span id="profile-tasks-done">...</span></div>
        </div>
        <div class="info-card">
            <h3><i class="fa-solid fa-share-nodes"></i> Referral Link</h3>
            <div class="referral-link-container">
                <input type="text" id="referral-link" readonly>
                <button id="copy-btn"><i class="fa-regular fa-copy"></i> Copy</button>
            </div>
        </div>
    </div>
    <!-- Withdraw Section -->
    <div id="withdraw-section" class="main-content">
         <div class="info-card"><h3><i class="fa-solid fa-wallet"></i> Withdraw RiX</h3><p>Withdrawal feature is under development.</p></div>
    </div>
    <!-- Bottom Navigation Bar -->
    <div class="bottom-nav">
        <button class="nav-button active" data-section="mining-section"><i class="fa-solid fa-person-digging"></i><span>Mining</span></button>
        <button class="nav-button" data-section="task-section"><i class="fa-solid fa-list-check"></i><span>Tasks</span></button>
        <button class="nav-button" data-section="account-section"><i class="fa-solid fa-user"></i><span>Account</span></button>
        <button class="nav-button" data-section="withdraw-section"><i class="fa-solid fa-wallet"></i><span>Withdraw</span></button>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
   // --- টেলিগ্রাম ওয়েব অ্যাপ অবজেক্ট ইনিশিয়ালাইজেশন ---
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();
tg.setHeaderColor('#171a21'); // ডার্ক থিমের সাথে মিল রেখে হেডার কালার

// --- DOM (Document Object Model) Elements ---
// পেজের বিভিন্ন অংশকে ধরার জন্য ভেরিয়েবল
const sections = document.querySelectorAll('.main-content');
const navButtons = document.querySelectorAll('.nav-button');
const startTaskBtn = document.getElementById('start-task-btn');
const miningClaimBtn = document.getElementById('mining-claim-btn');
const miningTimerElem = document.getElementById('mining-timer');
const copyBtn = document.getElementById('copy-btn');

// --- গ্লোবাল ভেরিয়েবল ---
let userData = null; // ব্যবহারকারীর সব ডেটা এখানে সেভ হবে
let miningInterval; // মাইনিং টাইমারের জন্য
const DAILY_TASK_LIMIT = 100;
const MINING_COOLDOWN_HOURS = 8;

// --- নেভিগেশন লজিক ---
// নিচের বাটনে ক্লিক করলে সঠিক সেকশন দেখানোর জন্য
navButtons.forEach(button => {
    button.addEventListener('click', () => {
        const sectionId = button.dataset.section;
        // সব সেকশন লুকিয়ে ফেলুন
        sections.forEach(sec => sec.classList.remove('active'));
        // সব বাটনের অ্যাক্টিভ স্টাইল সরিয়ে দিন
        navButtons.forEach(btn => btn.classList.remove('active'));
        
        // নির্দিষ্ট সেকশনটি দেখান
        document.getElementById(sectionId).classList.add('active');
        // নির্দিষ্ট বাটনটিকে অ্যাক্টিভ করুন
        button.classList.add('active');
        
        // ব্যবহারকারীকে একটি হালকা ভাইব্রেশন দিন
        tg.HapticFeedback.impactOccurred('light');
    });
});

// --- ডেটা লোডিং এবং UI আপডেট ---

// সার্ভার থেকে ব্যবহারকারীর সব ডেটা নিয়ে আসার ফাংশন
async function loadUserData() {
    // নিশ্চিত করুন যে টেলিগ্রাম ব্যবহারকারীকে সনাক্ত করতে পারছে
    if (!tg.initDataUnsafe.user?.id) {
        return showError("Critical Error: User authentication failed. Please restart the app.");
    }
    const user = tg.initDataUnsafe.user;
    
    // API তে পাঠানোর জন্য URL তৈরি করুন
    const queryParams = new URLSearchParams({
        user_id: user.id,
        first_name: user.first_name || 'Player',
        username: user.username || ''
    });
    const apiUrl = `/api/user_data?${queryParams.toString()}`;
    
    try {
        const response = await fetch(apiUrl);
        if (!response.ok) {
            throw new Error('Failed to load user data from server.');
        }
        userData = await response.json();
        updateAllUI(); // ডেটা পাওয়ার পর UI আপডেট করুন
    } catch (error) {
        showError(error.message);
    }
}

// নতুন ডেটা দিয়ে সব সেকশনের UI আপডেট করার ফাংশন
function updateAllUI() {
    if (!userData) return;
    
    const completedTasks = userData.daily_tasks_completed || 0;
    const balance = userData.rix_balance || 0;
    
    // Task Section UI
    document.getElementById('tasks-completed').innerText = completedTasks;
    document.getElementById('tasks-remaining').innerText = DAILY_TASK_LIMIT - completedTasks;
    startTaskBtn.disabled = completedTasks >= DAILY_TASK_LIMIT;
    startTaskBtn.innerText = completedTasks >= DAILY_TASK_LIMIT ? "All Tasks Done" : "Watch Ad (+200 RiX)";
    
    // Account Section UI
    document.getElementById('profile-name').innerText = userData.first_name;
    document.getElementById('profile-balance').innerText = formatBalance(balance) + ' RiX';
    document.getElementById('profile-tasks-done').innerText = `${completedTasks} / ${DAILY_TASK_LIMIT}`;
    
    // Referral Link UI
    const botUsername = "Rix_earn_bot"; // আপনার আসল বটের ইউজারনেম
    document.getElementById('referral-link').value = `https://t.me/${botUsername}?start=${userData.referral_code}`;
    
    // Mining Section UI
    updateMiningStatus();
}

// শুধুমাত্র মাইনিং টাইমার এবং বাটন আপডেট করার ফাংশন
function updateMiningStatus() {
    if (!userData) return;
    
    const lastClaimTime = userData.last_mining_claim ? new Date(userData.last_mining_claim) : null;
    if (miningInterval) clearInterval(miningInterval); // পুরনো টাইমার বন্ধ করুন

    if (!lastClaimTime) {
        miningClaimBtn.disabled = false;
        miningClaimBtn.innerText = "Claim Mining Reward";
        miningTimerElem.innerText = "Ready to claim your first reward!";
        return;
    }

    const nextClaimTime = new Date(lastClaimTime.getTime() + MINING_COOLDOWN_HOURS * 60 * 60 * 1000);
    
    function updateTimer() {
        const now = new Date();
        const timeLeft = nextClaimTime - now;

        if (timeLeft <= 0) {
            miningClaimBtn.disabled = false;
            miningClaimBtn.innerText = "Claim Mining Reward";
            miningTimerElem.innerText = "Ready to claim!";
            clearInterval(miningInterval);
        } else {
            miningClaimBtn.disabled = true;
            miningClaimBtn.innerText = "Mining...";
            const h = Math.floor(timeLeft / 3600000);
            const m = Math.floor((timeLeft % 3600000) / 60000);
            const s = Math.floor((timeLeft % 60000) / 1000);
            miningTimerElem.innerText = `Next claim in: ${pad(h)}:${pad(m)}:${pad(s)}`;
        }
    }
    updateTimer(); // সাথে সাথে একবার চালান
    miningInterval = setInterval(updateTimer, 1000); // প্রতি সেকেন্ডে চালান
}

// --- Monetag Rewarded Interstitial অ্যাড দেখানোর ফাংশন ---
function showMonetagAd() {
    return new Promise((resolve, reject) => {
        // নিশ্চিত করুন যে Monetag-এর ফাংশনটি লোড হয়েছে
        if (typeof show_9504423 === 'function') {
            show_9504423().then(() => {
                // বিজ্ঞাপন সফলভাবে দেখার পর
                console.log("Ad seen successfully.");
                resolve(true);
            }).catch(error => {
                // যদি অ্যাড দেখাতে কোনো সমস্যা হয়
                console.error("Monetag Ad error:", error);
                reject(error);
            });
        } else {
            // যদি Monetag SDK লোড না হয়
            console.error("Monetag SDK function not found.");
            reject(new Error("Ad service is not available."));
        }
    });
}

// --- সব বাটনের জন্য Event Listeners ---

// টাস্ক বাটনের জন্য
startTaskBtn.addEventListener('click', async () => {
    if (startTaskBtn.disabled) return;
    startTaskBtn.disabled = true;
    startTaskBtn.innerText = "Loading Ad...";
    tg.HapticFeedback.impactOccurred('light');

    try {
        await showMonetagAd(); // অ্যাড দেখান এবং শেষ হওয়ার জন্য অপেক্ষা করুন
        
        // অ্যাড দেখা শেষ হলে, সার্ভারে রিওয়ার্ড ক্লেইম করুন
        const response = await fetch('/api/complete_task', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: tg.initDataUnsafe.user.id })
        });
        const result = await response.json();

        if (result.success) {
            tg.HapticFeedback.notificationOccurred('success');
            tg.showAlert(result.message);
            userData = result.user_data; // সার্ভার থেকে নতুন ডেটা নিন
            updateAllUI();
        } else {
            showError(result.message || "Task failed.");
            updateAllUI(); // UI আপডেট করুন, কারণ টাস্ক লিমিট পূর্ণ হতে পারে
        }
    } catch (error) {
        showError("Ad could not be shown. Please try again later.");
        startTaskBtn.disabled = false;
        startTaskBtn.innerText = "Watch Ad (+200 RiX)";
    }
});

// মাইনিং বাটনের জন্য
miningClaimBtn.addEventListener('click', async () => {
    if (!userData) return showError("User data not loaded.");
    miningClaimBtn.disabled = true;
    miningClaimBtn.innerText = "Claiming...";
    try {
        const response = await fetch('/api/claim_mining', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userData.user_id })
        });
        const result = await response.json();
        if (result.success) {
            tg.HapticFeedback.notificationOccurred('success');
            tg.showAlert(result.message);
            userData = result.user_data;
            updateAllUI();
        } else {
            showError(result.message);
            updateMiningStatus();
        }
    } catch (error) {
        showError("An error occurred during mining claim.");
    }
});

// কপি বাটনের জন্য
copyBtn.addEventListener('click', () => {
    const linkInput = document.getElementById('referral-link');
    navigator.clipboard.writeText(linkInput.value)
        .then(() => {
            tg.HapticFeedback.notificationOccurred('success');
            tg.showAlert('Referral link copied!');
        })
        .catch(() => showError('Could not copy link.'));
});

// --- Helper Functions ---
function formatBalance(num) {
    return new Intl.NumberFormat().format(Math.floor(num));
}
function pad(n) {
    return n < 10 ? '0' + n : n;
}
function showError(message) {
    tg.showAlert(message);
}

// --- Initial Load ---
// অ্যাপটি খোলার সাথে সাথে এই ফাংশনটি রান হবে
loadUserData();


</script>
</body>
</html>
