# --- ‡¶ß‡¶æ‡¶™ ‡ßß: nest_asyncio (‡¶è‡¶ü‡¶ø ‡¶è‡¶ï‡ßá‡¶¨‡¶æ‡¶∞‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶§‡ßá ‡¶•‡¶æ‡¶ï‡¶¨‡ßá ‡¶¨‡¶æ‡¶°‡¶º‡¶§‡¶ø ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶§‡ßç‡¶§‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø) ---
import nest_asyncio
nest_asyncio.apply()

# --- ‡¶ß‡¶æ‡¶™ ‡ß®: ‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßÄ‡¶Ø‡¶º ‡¶≤‡¶æ‡¶á‡¶¨‡ßç‡¶∞‡ßá‡¶∞‡¶ø ---
import os
import asyncio
import uuid
from fastapi import FastAPI, Request, Response
from telegram import Update, Bot, InlineKeyboardButton, InlineKeyboardMarkup
from supabase import create_client, Client
from datetime import datetime, timedelta, timezone
from dateutil.parser import parse

# --- ‡¶ß‡¶æ‡¶™ ‡ß©: ‡¶è‡¶®‡¶≠‡¶æ‡¶Ø‡¶º‡¶∞‡¶®‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶≠‡ßá‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶¨‡¶≤ ‡¶è‡¶¨‡¶Ç ‡¶ï‡ßç‡¶≤‡¶æ‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ---
TOKEN = os.environ.get("TELEGRAM_TOKEN")
SUPABASE_URL = os.environ.get("SUPABASE_URL")
SUPABASE_KEY = os.environ.get("SUPABASE_KEY")
VERCEL_URL = os.environ.get("VERCEL_URL")

bot = Bot(token=TOKEN)
supabase: Client = create_client(SUPABASE_URL, SUPABASE_KEY)

# FastAPI ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï docs ‡¶™‡ßá‡¶ú ‡¶õ‡¶æ‡¶°‡¶º‡¶æ)
app = FastAPI(docs_url=None, redoc_url=None)

# --- ‡¶ß‡¶æ‡¶™ ‡ß™: ‡¶ó‡ßá‡¶Æ‡ßá‡¶∞ ‡¶®‡¶ø‡¶Ø‡¶º‡¶Æ ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶ï ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ---
NEW_USER_BONUS = 2000
REFERRAL_BONUS = 1000
MINING_REWARD = 200
MINING_INTERVAL_HOURS = 6

def generate_referral_code():
    return str(uuid.uuid4())[:8]

def update_rix_balance(user_id, amount_to_add):
    try:
        user_data = supabase.table('users').select('rix_balance').eq('user_id', user_id).single().execute()
        current_balance = user_data.data.get('rix_balance', 0) if user_data.data else 0
        new_balance = current_balance + amount_to_add
        supabase.table('users').update({'rix_balance': new_balance}).eq('user_id', user_id).execute()
    except Exception as e:
        print(f"‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ (User ID: {user_id}): {e}")

def get_main_menu_keyboard():
    keyboard = [
        [InlineKeyboardButton("‚õèÔ∏è ‡¶Æ‡¶æ‡¶á‡¶®‡¶ø‡¶Ç ‡¶π‡¶æ‡¶¨", callback_data="mining_hub")],
        [InlineKeyboardButton("üí∞ ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏", callback_data="check_balance")],
        [InlineKeyboardButton("ü§ù ‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®", callback_data="refer_friend")]
    ]
    return InlineKeyboardMarkup(keyboard)

# --- ‡¶ß‡¶æ‡¶™ ‡ß´: ‡¶Æ‡ßÇ‡¶≤ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï‡ßç‡¶∞‡ßã‡¶®‡¶æ‡¶∏ ‡¶≤‡¶ú‡¶ø‡¶ï ---
async def handle_update(update_data):
    update = Update.de_json(update_data, bot)
    
    if update.message and update.message.text:
        user = update.message.from_user
        chat_id = update.message.chat_id
        text = update.message.text
        
        if text.startswith('/start'):
            command_parts = text.split(); referrer_id = None
            if len(command_parts) > 1:
                referrer_data = supabase.table('users').select('user_id').eq('referral_code', command_parts[1]).single().execute()
                if referrer_data.data: referrer_id = referrer_data.data['user_id']
            
            existing_user = supabase.table('users').select('user_id').eq('user_id', user.id).single().execute()

            if not existing_user.data:
                initial_balance = NEW_USER_BONUS
                if referrer_id and referrer_id != user.id:
                    update_rix_balance(referrer_id, REFERRAL_BONUS)
                    await bot.send_message(chat_id=referrer_id, text=f"üéâ ‡¶Ö‡¶≠‡¶ø‡¶®‡¶®‡ßç‡¶¶‡¶®! {user.first_name} ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤‡ßá ‡¶Ø‡ßã‡¶ó ‡¶¶‡¶ø‡ßü‡ßá‡¶õ‡ßá‡¶®‡•§ ‡¶Ü‡¶™‡¶®‡¶ø {REFERRAL_BONUS} RiX ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶™‡ßá‡ßü‡ßá‡¶õ‡ßá‡¶®!")
                
                supabase.table('users').insert({'user_id': user.id, 'first_name': user.first_name, 'referral_code': generate_referral_code(), 'rix_balance': initial_balance, 'referred_by': referrer_id}).execute()
                welcome_message = f"‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ, {user.first_name}! ‡¶Ü‡¶™‡¶®‡¶ø ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá {NEW_USER_BONUS} RiX ‡¶™‡ßá‡ßü‡ßá‡¶õ‡ßá‡¶®!"
            else:
                welcome_message = f"‡¶´‡¶ø‡¶∞‡ßá ‡¶Ü‡¶∏‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶, {user.first_name}!"
            
            await bot.send_message(chat_id=chat_id, text=welcome_message, reply_markup=get_main_menu_keyboard())

    elif update.callback_query:
        query = update.callback_query
        user_id = query.from_user.id
        await query.answer()
        back_button = [InlineKeyboardButton("‚¨ÖÔ∏è ‡¶Æ‡ßá‡¶®‡ßÅ‡¶§‡ßá ‡¶´‡¶ø‡¶∞‡ßÅ‡¶®", callback_data="back_to_menu")]

        if query.data == "check_balance":
            user_data = supabase.table('users').select('rix_balance').eq('user_id', user_id).single().execute()
            balance = user_data.data.get('rix_balance', 0) if user_data.data else 0
            await query.edit_message_text(text=f"‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® RiX ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: {balance} üí∞", reply_markup=InlineKeyboardMarkup([back_button]))

        elif query.data == "mining_hub":
            user_data = supabase.table('users').select('last_mining_claim').eq('user_id', user_id).single().execute()
            last_claim_str = user_data.data.get('last_mining_claim') if user_data.data else None
            can_claim = False; message = ""
            if not last_claim_str:
                can_claim = True; message = "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶Æ‡¶æ‡¶á‡¶®‡¶ø‡¶Ç ‡¶∏‡ßá‡¶∂‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ï‡ßç‡¶≤‡ßá‡¶á‡¶Æ ‡¶ï‡¶∞‡ßÅ‡¶®!"
            else:
                last_claim_time = parse(last_claim_str)
                next_claim_time = last_claim_time + timedelta(hours=MINING_INTERVAL_HOURS)
                if datetime.now(timezone.utc) >= next_claim_time:
                    can_claim = True; message = "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡¶æ‡¶á‡¶®‡¶ø‡¶Ç ‡¶∏‡ßá‡¶∂‡¶® ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§! ‡¶è‡¶ñ‡¶®‡¶ø ‡¶ï‡ßç‡¶≤‡ßá‡¶á‡¶Æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§"
                else:
                    remaining = next_claim_time - datetime.now(timezone.utc); hours, rem = divmod(remaining.seconds, 3600); minutes, _ = divmod(rem, 60)
                    message = f"‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶ï‡ßç‡¶≤‡ßá‡¶á‡¶Æ‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§\n‡¶∏‡¶Æ‡ßü ‡¶¨‡¶æ‡¶ï‡¶ø: {hours} ‡¶ò‡¶®‡ßç‡¶ü‡¶æ {minutes} ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü"
            
            keyboard = []
            if can_claim: keyboard.append([InlineKeyboardButton(f"‚úÖ {MINING_REWARD} RiX ‡¶ï‡ßç‡¶≤‡ßá‡¶á‡¶Æ ‡¶ï‡¶∞‡ßÅ‡¶®", callback_data="claim_reward")])
            keyboard.append(back_button)
            await query.edit_message_text(text=message, reply_markup=InlineKeyboardMarkup(keyboard))

        elif query.data == "claim_reward":
            update_rix_balance(user_id, MINING_REWARD)
            now_utc = datetime.now(timezone.utc).isoformat()
            supabase.table('users').update({'last_mining_claim': now_utc}).eq('user_id', user_id).execute()
            await query.edit_message_text(text=f"‡¶Ö‡¶≠‡¶ø‡¶®‡¶®‡ßç‡¶¶‡¶®! ‡¶Ü‡¶™‡¶®‡¶ø {MINING_REWARD} RiX ‡¶™‡ßá‡ßü‡ßá‡¶õ‡ßá‡¶®‡•§", reply_markup=InlineKeyboardMarkup([back_button]))

        elif query.data == "refer_friend":
            user_data = supabase.table('users').select('referral_code').eq('user_id', user_id).single().execute()
            ref_code = user_data.data.get('referral_code', 'N/A') if user_data.data else 'N/A'
            bot_info = await bot.get_me()
            ref_link = f"https://t.me/{bot_info.username}?start={ref_code}"
            await query.edit_message_text(text=f"‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶¶‡ßá‡¶∞ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá RiX ‡¶Ü‡ßü ‡¶ï‡¶∞‡ßÅ‡¶®!\n\n‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï:\n`{ref_link}`", parse_mode='Markdown', reply_markup=InlineKeyboardMarkup([back_button]))

        elif query.data == "back_to_menu":
            await query.edit_message_text(text="‡¶™‡ßç‡¶∞‡¶ß‡¶æ‡¶® ‡¶Æ‡ßá‡¶®‡ßÅ:", reply_markup=get_main_menu_keyboard())


# --- ‡¶ß‡¶æ‡¶™ ‡ß¨: Vercel ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ì‡¶Ø‡¶º‡ßá‡¶¨ ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ (Catch-all ‡¶∞‡ßÅ‡¶ü) ---

@app.api_route("/{full_path:path}", methods=["GET", "POST"])
async def universal_handler(request: Request, full_path: str):
    """
    ‡¶è‡¶á ‡¶è‡¶ï‡¶ü‡¶ø ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶á GET ‡¶è‡¶¨‡¶Ç POST ‡¶â‡¶≠‡¶Ø‡¶º ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶¨ ‡¶™‡¶æ‡¶• ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡ßá‡¶≤ ‡¶ï‡¶∞‡¶¨‡ßá‡•§
    """
    # ‡¶Ø‡¶¶‡¶ø ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü‡¶ü‡¶ø /setwebhook ‡¶™‡¶æ‡¶•‡ßá ‡¶Ü‡¶∏‡ßá (GET)
    if full_path == "setwebhook" and request.method == "GET":
        try:
            if not VERCEL_URL:
                return Response(content="Error: VERCEL_URL is not set.", status_code=500)
            
            webhook_url = f"https://{VERCEL_URL}/"
            await bot.set_webhook(url=webhook_url, allowed_updates=['message', 'callback_query'])
            return Response(content="Webhook ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!")
        except Exception as e:
            print(f"CRITICAL Error in set_webhook_route: {e}")
            return Response(content=f"An internal error occurred: {e}", status_code=500)
    
    # ‡¶Ø‡¶¶‡¶ø ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü‡¶ü‡¶ø root path (/) ‡¶è ‡¶Ü‡¶∏‡ßá ‡¶è‡¶¨‡¶Ç POST ‡¶π‡ßü (‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶•‡ßá‡¶ï‡ßá)
    elif full_path == "" and request.method == "POST":
        try:
            update_data = await request.json()
            await handle_update(update_data)
        except Exception as e:
            print(f"Error in webhook handler: {e}")
        return Response(status_code=200)
        
    # ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶æ‡¶• ‡¶¨‡¶æ ‡¶Æ‡ßá‡¶•‡¶°‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø 404 Not Found
    else:
        return Response(content="Not Found", status_code=404)
